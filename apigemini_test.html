<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>OAdsAI_GASBackend</title>
  <link rel="icon" href="assets/TRKKN_icon.png" type="image/png" />

  <style> 
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 700px;
      margin: auto;
      background: #f4f4f4;
    }  
    h2 {
      text-align: center;
      color: #333;
    }
    textarea, pre {
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      display: inline-block;
      padding: 10px 18px;
      font-size: 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 15px;
      margin-right: 10px;
    }
    button:hover {
      background: #45a049;
    }
    #respuesta {
      background: white;
      white-space: pre-wrap;
      min-height: 120px;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 6px;
      font-family: monospace;
    }
    #imagen {
      display: block;
      max-width: 100%;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-top: 10px;
    }
    label, textarea, button, pre {
      display: block;
      margin-top: 5px;
    }
  </style>

  <!-- 🔒 Protección con Firebase -->
  <style id="hide-body-style">
    body { display: none; } 
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { firebaseConfig } from "./firebase-config.js";
  
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
  
    onAuthStateChanged(auth, user => {
      if (!user) {
        alert("🔒 Inicia sesión Trkkie!");
        window.location.href = "auth.html";
      } else {
        console.log("✅ Usuario autenticado:", user.email);
        document.getElementById("hide-body-style")?.remove();
        document.body.style.display = "block";
      }
    });
  </script>
</head>
  
<body>
  <h2>Test HTML_GASBackend_Gemini + Stability</h2>
  
  <label>Prompt:</label>
  <textarea id="prompt" placeholder="Escribe tu prompt aquí..."></textarea>
  
  <!-- 🔘 Botones -->
  <button id="sendText">Gemini (Texto)</button>
  <button id="sendImage">Stability (Imagen)</button>
    
  <label>Respuesta:</label>
  <pre id="respuesta">Esperando respuesta...</pre>

  <!-- Contenedor para imágenes -->
  <img id="imagen" style="display:none;" alt="Imagen generada" />
  
  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwVXklQ2ljmMUxys7fCh5ygUyS3jheoHQO3SIYvLr9ETQcOABgrMdaLrCEiiDBpStmW/exec";
    const omniToken = "gIe1TET33hc4i1w9K0WvcS6DHMIYjCgm5fgRqUWS";

    async function enviarPrompt(action) {
      const prompt = document.getElementById("prompt").value.trim();
      if (!prompt) return alert("Escribe un prompt primero.");

      document.getElementById("respuesta").textContent = "⏳ Generando...";
      document.getElementById("imagen").style.display = "none";

      try {
        const res = await fetch(GAS_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + omniToken
          },
          body: JSON.stringify({ prompt, action })
        });

        const data = await res.json();
        console.log("Respuesta completa:", data);

        if (data.error) {
          document.getElementById("respuesta").textContent = "❌ Error: " + data.error;
          return;
        }

        if (action === "text2text") {
          document.getElementById("respuesta").textContent = data.result || "Sin respuesta";
        } else if (action === "text2image") {
          if (data.result && data.result.startsWith("data:image")) {
            document.getElementById("respuesta").textContent = "✅ Imagen generada:";
            const img = document.getElementById("imagen");
            img.src = data.result;
            img.style.display = "block";
          } else {
            document.getElementById("respuesta").textContent = data.result || "⚠️ No se generó imagen.";
          }
        }
      } catch (err) {
        console.error("Error:", err);
        document.getElementById("respuesta").textContent = "❌ Error al conectar con el backend.";
      }
    }

    document.getElementById("sendText").addEventListener("click", () => enviarPrompt("text2text"));
    document.getElementById("sendImage").addEventListener("click", () => enviarPrompt("text2image"));
  </script>
</body>
</html>
